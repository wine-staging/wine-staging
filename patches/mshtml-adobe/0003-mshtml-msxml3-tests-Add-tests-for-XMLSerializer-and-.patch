From 9854b0c70a3f8d38760bc77bd800a28a714e2a2b Mon Sep 17 00:00:00 2001
From: Phiality <bakreski03@gmail.com>
Date: Thu, 5 Feb 2026 10:12:57 +1100
Subject: [PATCH] mshtml/msxml3/tests: Add tests for XMLSerializer and embedded
 XML declarations.

---
 dlls/mshtml/tests/documentmode.js |   3 +-
 dlls/mshtml/tests/dom.js          | 101 +++++++++++++++
 dlls/msxml3/tests/domdoc.c        | 200 ++++++++++++++++++++++++++++++
 3 files changed, 303 insertions(+), 1 deletion(-)

diff --git a/dlls/mshtml/tests/documentmode.js b/dlls/mshtml/tests/documentmode.js
index dadd7ba6b04..71a14a7d322 100644
--- a/dlls/mshtml/tests/documentmode.js
+++ b/dlls/mshtml/tests/documentmode.js
@@ -4453,6 +4453,7 @@ sync_test("prototype props", function() {
     check(DocumentFragment, [ ["attachEvent",9,10], ["detachEvent",9,10], "querySelector", "querySelectorAll", "removeNode", "replaceNode", "swapNode" ]);
     check(DocumentType, [ "entities", "internalSubset", "name", "notations", "publicId", "systemId" ]);
     check(DOMParser, [ "parseFromString" ]);
+    check(XMLSerializer, [ "serializeToString" ]);
     check(Element, [
         "childElementCount", "clientHeight", "clientLeft", "clientTop", "clientWidth", ["fireEvent",9,10], "firstElementChild",
         "getAttribute", "getAttributeNS", "getAttributeNode", "getAttributeNodeNS", "getBoundingClientRect", "getClientRects",
@@ -4895,7 +4896,7 @@ async_test("window own props", function() {
             ["URL",10], ["ValidityState",10], ["VideoPlaybackQuality",11], ["WebGLActiveInfo",11], ["WebGLBuffer",11], ["WebGLContextEvent",11],
             ["WebGLFramebuffer",11], ["WebGLObject",11], ["WebGLProgram",11], ["WebGLRenderbuffer",11], ["WebGLRenderingContext",11], ["WebGLShader",11], ["WebGLShaderPrecisionFormat",11],
             ["WebGLTexture",11], ["WebGLUniformLocation",11], ["WEBGL_compressed_texture_s3tc",11], ["WEBGL_debug_renderer_info",11], ["WebSocket",10], "WheelEvent", ["Worker",10],
-            ["XMLHttpRequestEventTarget",10], "XMLSerializer"
+            ["XMLHttpRequestEventTarget",10]
         ]);
         next_test();
     }
diff --git a/dlls/mshtml/tests/dom.js b/dlls/mshtml/tests/dom.js
index 92c1deb64d3..dcf75b1324c 100644
--- a/dlls/mshtml/tests/dom.js
+++ b/dlls/mshtml/tests/dom.js
@@ -1170,3 +1170,104 @@ sync_test("document.open", function() {
     doc.close();
     ok(doc.onclick === f, "doc.onclick != f");
 });
+
+sync_test("XMLSerializer", function() {
+    var serializer = new XMLSerializer();
+    ok(serializer !== null, "XMLSerializer constructor returned null");
+    ok(typeof serializer === "object", "XMLSerializer is not an object");
+
+    /* Test serializeToString with a simple element */
+    var div = document.createElement("div");
+    div.id = "testdiv";
+    div.innerHTML = "test content";
+
+    var result = serializer.serializeToString(div);
+    ok(typeof result === "string", "serializeToString did not return a string");
+    ok(result.length > 0, "serializeToString returned empty string");
+    ok(result.indexOf("testdiv") !== -1, "serialized string does not contain id: " + result);
+    ok(result.indexOf("test content") !== -1, "serialized string does not contain content: " + result);
+
+    /* Test with nested elements */
+    var container = document.createElement("div");
+    var child = document.createElement("span");
+    child.textContent = "nested";
+    container.appendChild(child);
+
+    result = serializer.serializeToString(container);
+    ok(result.indexOf("span") !== -1, "serialized string does not contain span tag: " + result);
+    ok(result.indexOf("nested") !== -1, "serialized string does not contain nested text: " + result);
+
+    /* Test with attributes */
+    var elem = document.createElement("input");
+    elem.type = "text";
+    elem.value = "test value";
+
+    result = serializer.serializeToString(elem);
+    ok(result.indexOf("input") !== -1, "serialized string does not contain input tag: " + result);
+
+    /* Test with empty element */
+    var empty = document.createElement("br");
+    result = serializer.serializeToString(empty);
+    ok(typeof result === "string", "serializeToString on empty element did not return string");
+    ok(result.indexOf("br") !== -1, "serialized empty element does not contain tag name: " + result);
+
+    /* Test with text node */
+    var textContainer = document.createElement("p");
+    textContainer.appendChild(document.createTextNode("plain text content"));
+    result = serializer.serializeToString(textContainer);
+    ok(result.indexOf("plain text content") !== -1, "serialized text node missing content: " + result);
+
+    /* Test with special characters that need escaping */
+    var specialChars = document.createElement("div");
+    specialChars.textContent = "<test> & \"quotes\"";
+    result = serializer.serializeToString(specialChars);
+    ok(result.indexOf("&lt;") !== -1 || result.indexOf("<test>") === -1,
+        "special characters should be escaped or not appear literally: " + result);
+
+    /* Test with deeply nested elements */
+    var outer = document.createElement("div");
+    var middle = document.createElement("span");
+    var inner = document.createElement("em");
+    inner.textContent = "deep";
+    middle.appendChild(inner);
+    outer.appendChild(middle);
+    result = serializer.serializeToString(outer);
+    ok(result.indexOf("div") !== -1, "missing outer div: " + result);
+    ok(result.indexOf("span") !== -1, "missing middle span: " + result);
+    ok(result.indexOf("em") !== -1, "missing inner em: " + result);
+    ok(result.indexOf("deep") !== -1, "missing deep text: " + result);
+
+    /* Test with multiple children */
+    var parent = document.createElement("ul");
+    for (var i = 0; i < 3; i++) {
+        var li = document.createElement("li");
+        li.textContent = "item" + i;
+        parent.appendChild(li);
+    }
+    result = serializer.serializeToString(parent);
+    ok(result.indexOf("item0") !== -1, "missing item0: " + result);
+    ok(result.indexOf("item1") !== -1, "missing item1: " + result);
+    ok(result.indexOf("item2") !== -1, "missing item2: " + result);
+
+    /* Test that multiple serializers work independently */
+    var serializer2 = new XMLSerializer();
+    ok(serializer2 !== null, "second XMLSerializer constructor returned null");
+    ok(serializer !== serializer2, "serializers should be different instances");
+
+    var div1 = document.createElement("div");
+    div1.id = "first";
+    var div2 = document.createElement("div");
+    div2.id = "second";
+
+    var result1 = serializer.serializeToString(div1);
+    var result2 = serializer2.serializeToString(div2);
+    ok(result1.indexOf("first") !== -1, "first serializer wrong result: " + result1);
+    ok(result2.indexOf("second") !== -1, "second serializer wrong result: " + result2);
+});
+
+sync_test("method_reference_call", function() {
+    /* Test calling a method stored in a variable (uses METHOD|PROPERTYGET internally) */
+    var f = document.body.getElementsByTagName;
+    var r = f.call(document.body, "test");
+    ok(r.length === 0, "r.length = " + r.length);
+});
diff --git a/dlls/msxml3/tests/domdoc.c b/dlls/msxml3/tests/domdoc.c
index 8d948ada766..e9ea6bcae42 100644
--- a/dlls/msxml3/tests/domdoc.c
+++ b/dlls/msxml3/tests/domdoc.c
@@ -14386,6 +14386,205 @@ static void test_indent(void)
     SysFreeString(str);
 }
 
+static void test_embedded_xml_declaration(void)
+{
+    IXMLDOMDocument *doc;
+    IXMLDOMElement *elem;
+    IXMLDOMNode *node;
+    IXMLDOMNodeList *nodes;
+    BSTR str;
+    VARIANT_BOOL b;
+    HRESULT hr;
+    LONG len;
+
+    /* Test XML with embedded <?xml?> declaration inside an element.
+     * Windows MSXML tolerates this but libxml2 rejects it.
+     * The implementation wraps such content in CDATA to make it parse. */
+    static const char embedded_xml_str[] =
+        "<?xml version=\"1.0\"?>"
+        "<root>"
+        "  <xmldata><?xml version=\"1.0\"?><nested>content</nested></xmldata>"
+        "</root>";
+
+    /* Test with xml:space preserved content containing XML declaration */
+    static const char embedded_xml_space_str[] =
+        "<?xml version=\"1.0\"?>"
+        "<root xml:space=\"preserve\">"
+        "  <?xml version=\"1.0\"?><data>test</data>"
+        "</root>";
+
+    /* Test normal XML without embedded declarations (should still work) */
+    static const char normal_xml_str[] =
+        "<?xml version=\"1.0\"?>"
+        "<root><child>text</child></root>";
+
+    /* Test *XMLData element pattern - element content that should be wrapped */
+    static const char xmldata_element_str[] =
+        "<?xml version=\"1.0\"?>"
+        "<root>"
+        "  <CustomXMLData><item>value</item></CustomXMLData>"
+        "</root>";
+
+    /* Test multiple embedded declarations */
+    static const char multi_embedded_str[] =
+        "<?xml version=\"1.0\"?>"
+        "<root>"
+        "  <first><?xml version=\"1.0\"?><a>1</a></first>"
+        "  <second><b>2</b></second>"
+        "</root>";
+
+    /* Test deeply nested embedded declaration */
+    static const char deep_embedded_str[] =
+        "<?xml version=\"1.0\"?>"
+        "<root><level1><level2><data><?xml version=\"1.0\"?><deep>nested</deep></data></level2></level1></root>";
+
+    /* Test with encoding in embedded declaration */
+    static const char embedded_with_encoding_str[] =
+        "<?xml version=\"1.0\"?>"
+        "<root>"
+        "  <xmldata><?xml version=\"1.0\" encoding=\"UTF-8\"?><test>encoded</test></xmldata>"
+        "</root>";
+
+    /* Test self-closing XMLData element (should not need wrapping) */
+    static const char selfclose_xmldata_str[] =
+        "<?xml version=\"1.0\"?>"
+        "<root><EmptyXMLData/></root>";
+
+    doc = NULL;
+    hr = CoCreateInstance(&CLSID_DOMDocument30, NULL, CLSCTX_INPROC_SERVER,
+            &IID_IXMLDOMDocument, (void**)&doc);
+    if (hr != S_OK)
+    {
+        win_skip("DOMDocument30 not available, skipping embedded XML tests\n");
+        return;
+    }
+
+    /* Test 1: Normal XML should parse fine */
+    b = VARIANT_FALSE;
+    hr = IXMLDOMDocument_loadXML(doc, _bstr_(normal_xml_str), &b);
+    ok(hr == S_OK, "loadXML failed: %#lx\n", hr);
+    ok(b == VARIANT_TRUE, "failed to load normal XML\n");
+
+    hr = IXMLDOMDocument_get_documentElement(doc, &elem);
+    ok(hr == S_OK, "get_documentElement failed: %#lx\n", hr);
+    if (elem)
+        IXMLDOMElement_Release(elem);
+
+    /* Test 2: XML with embedded declaration in element content */
+    b = VARIANT_FALSE;
+    hr = IXMLDOMDocument_loadXML(doc, _bstr_(embedded_xml_str), &b);
+    ok(hr == S_OK, "loadXML with embedded XML declaration failed: %#lx\n", hr);
+    ok(b == VARIANT_TRUE, "failed to load XML with embedded declaration\n");
+
+    if (b == VARIANT_TRUE)
+    {
+        hr = IXMLDOMDocument_get_documentElement(doc, &elem);
+        ok(hr == S_OK, "get_documentElement failed: %#lx\n", hr);
+        if (elem)
+            IXMLDOMElement_Release(elem);
+    }
+
+    /* Test 3: XML with embedded declaration and xml:space */
+    b = VARIANT_FALSE;
+    hr = IXMLDOMDocument_loadXML(doc, _bstr_(embedded_xml_space_str), &b);
+    ok(hr == S_OK, "loadXML with embedded XML and xml:space failed: %#lx\n", hr);
+    ok(b == VARIANT_TRUE, "failed to load XML with embedded declaration and xml:space\n");
+
+    /* Test 4: *XMLData element with element content */
+    b = VARIANT_FALSE;
+    hr = IXMLDOMDocument_loadXML(doc, _bstr_(xmldata_element_str), &b);
+    ok(hr == S_OK, "loadXML with *XMLData element failed: %#lx\n", hr);
+    ok(b == VARIANT_TRUE, "failed to load XML with *XMLData element\n");
+
+    if (b == VARIANT_TRUE)
+    {
+        hr = IXMLDOMDocument_get_documentElement(doc, &elem);
+        ok(hr == S_OK, "get_documentElement failed: %#lx\n", hr);
+        if (elem)
+        {
+            /* Verify we can access child elements */
+            hr = IXMLDOMElement_get_childNodes(elem, &nodes);
+            ok(hr == S_OK, "get_childNodes failed: %#lx\n", hr);
+            if (nodes)
+            {
+                hr = IXMLDOMNodeList_get_length(nodes, &len);
+                ok(hr == S_OK, "get_length failed: %#lx\n", hr);
+                ok(len > 0, "expected child nodes, got %ld\n", len);
+                IXMLDOMNodeList_Release(nodes);
+            }
+            IXMLDOMElement_Release(elem);
+        }
+    }
+
+    /* Test 5: Multiple embedded declarations in different elements */
+    b = VARIANT_FALSE;
+    hr = IXMLDOMDocument_loadXML(doc, _bstr_(multi_embedded_str), &b);
+    ok(hr == S_OK, "loadXML with multiple embedded declarations failed: %#lx\n", hr);
+    ok(b == VARIANT_TRUE, "failed to load XML with multiple embedded declarations\n");
+
+    if (b == VARIANT_TRUE)
+    {
+        hr = IXMLDOMDocument_get_documentElement(doc, &elem);
+        ok(hr == S_OK, "get_documentElement failed: %#lx\n", hr);
+        if (elem)
+        {
+            hr = IXMLDOMElement_get_childNodes(elem, &nodes);
+            ok(hr == S_OK, "get_childNodes failed: %#lx\n", hr);
+            if (nodes)
+            {
+                hr = IXMLDOMNodeList_get_length(nodes, &len);
+                ok(hr == S_OK, "get_length failed: %#lx\n", hr);
+                /* Should have at least 2 child elements (first and second) */
+                ok(len >= 2, "expected at least 2 child nodes, got %ld\n", len);
+                IXMLDOMNodeList_Release(nodes);
+            }
+            IXMLDOMElement_Release(elem);
+        }
+    }
+
+    /* Test 6: Deeply nested embedded declaration */
+    b = VARIANT_FALSE;
+    hr = IXMLDOMDocument_loadXML(doc, _bstr_(deep_embedded_str), &b);
+    ok(hr == S_OK, "loadXML with deeply nested embedded declaration failed: %#lx\n", hr);
+    ok(b == VARIANT_TRUE, "failed to load XML with deeply nested embedded declaration\n");
+
+    /* Test 7: Embedded declaration with encoding attribute */
+    b = VARIANT_FALSE;
+    hr = IXMLDOMDocument_loadXML(doc, _bstr_(embedded_with_encoding_str), &b);
+    ok(hr == S_OK, "loadXML with embedded encoding declaration failed: %#lx\n", hr);
+    ok(b == VARIANT_TRUE, "failed to load XML with embedded encoding declaration\n");
+
+    /* Test 8: Self-closing XMLData element (no content to wrap) */
+    b = VARIANT_FALSE;
+    hr = IXMLDOMDocument_loadXML(doc, _bstr_(selfclose_xmldata_str), &b);
+    ok(hr == S_OK, "loadXML with self-closing XMLData failed: %#lx\n", hr);
+    ok(b == VARIANT_TRUE, "failed to load XML with self-closing XMLData\n");
+
+    if (b == VARIANT_TRUE)
+    {
+        hr = IXMLDOMDocument_get_documentElement(doc, &elem);
+        ok(hr == S_OK, "get_documentElement failed: %#lx\n", hr);
+        if (elem)
+        {
+            hr = IXMLDOMElement_get_tagName(elem, &str);
+            ok(hr == S_OK, "get_tagName failed: %#lx\n", hr);
+            ok(!lstrcmpW(str, L"root"), "unexpected tag name: %s\n", wine_dbgstr_w(str));
+            SysFreeString(str);
+
+            /* Find the EmptyXMLData element */
+            hr = IXMLDOMElement_selectSingleNode(elem, _bstr_("EmptyXMLData"), &node);
+            ok(hr == S_OK, "selectSingleNode failed: %#lx\n", hr);
+            if (node)
+                IXMLDOMNode_Release(node);
+
+            IXMLDOMElement_Release(elem);
+        }
+    }
+
+    IXMLDOMDocument_Release(doc);
+    free_bstrs();
+}
+
 static DWORD WINAPI new_thread(void *arg)
 {
     HRESULT hr = CoInitialize(NULL);
@@ -14489,6 +14688,7 @@ START_TEST(domdoc)
     test_xsltemplate();
     test_xsltext();
     test_max_element_depth_values();
+    test_embedded_xml_declaration();
 
     if (is_clsid_supported(&CLSID_MXNamespaceManager40, &IID_IMXNamespaceManager))
     {
-- 
2.51.0


From fa933a9493c8b4a2e9626c1815bb5ef4309627b4 Mon Sep 17 00:00:00 2001
From: Connor McAdams <cmcadams@codeweavers.com>
Date: Wed, 3 Sep 2025 13:33:16 -0400
Subject: [PATCH] d3dx9: Implement
 ID3DXAnimationController::{Get,Set}TrackAnimationSet().

Signed-off-by: Connor McAdams <cmcadams@codeweavers.com>
---
 dlls/d3dx9_36/animation.c | 38 ++++++++++++++++++++++++++++++++++++--
 1 file changed, 36 insertions(+), 2 deletions(-)

diff --git a/dlls/d3dx9_36/animation.c b/dlls/d3dx9_36/animation.c
index 6ded652930a..ccd16778c3e 100644
--- a/dlls/d3dx9_36/animation.c
+++ b/dlls/d3dx9_36/animation.c
@@ -26,6 +26,7 @@ WINE_DEFAULT_DEBUG_CHANNEL(d3dx);
 struct d3dx9_track
 {
     D3DXTRACK_DESC desc;
+    int set_idx;
 };
 
 struct d3dx9_animation_controller
@@ -219,17 +220,47 @@ static double WINAPI d3dx9_animation_controller_GetTime(ID3DXAnimationController
 static HRESULT WINAPI d3dx9_animation_controller_SetTrackAnimationSet(ID3DXAnimationController *iface,
         UINT track, ID3DXAnimationSet *anim_set)
 {
+    struct d3dx9_animation_controller *animation = impl_from_ID3DXAnimationController(iface);
+    unsigned int i;
+    int idx;
+
     FIXME("iface %p, track %u, anim_set %p stub.\n", iface, track, anim_set);
 
-    return E_NOTIMPL;
+    if (track > animation->max_tracks || !anim_set || (animation->tracks[track].set_idx >= 0))
+        return D3DERR_INVALIDCALL;
+
+    idx = -1;
+    for (i = 0; i < animation->num_sets; i++)
+    {
+        if (animation->animation_sets[i] == anim_set)
+        {
+            idx = i;
+            break;
+        }
+    }
+
+    animation->tracks[track].set_idx = idx;
+
+    return idx >= 0 ? D3D_OK : D3DERR_INVALIDCALL;
 }
 
 static HRESULT WINAPI d3dx9_animation_controller_GetTrackAnimationSet(ID3DXAnimationController *iface,
         UINT track, ID3DXAnimationSet **anim_set)
 {
+    struct d3dx9_animation_controller *animation = impl_from_ID3DXAnimationController(iface);
+    int set_idx;
+
     FIXME("iface %p, track %u, anim_set %p stub.\n", iface, track, anim_set);
 
-    return E_NOTIMPL;
+    if (track > animation->max_tracks || !anim_set)
+        return D3DERR_INVALIDCALL;
+
+    set_idx = animation->tracks[track].set_idx;
+    *anim_set = set_idx >= 0 ? animation->animation_sets[set_idx] : NULL;
+
+    if (*anim_set)
+        (*anim_set)->lpVtbl->AddRef(*anim_set);
+    return D3D_OK;
 }
 
 static HRESULT WINAPI d3dx9_animation_controller_SetTrackPriority(ID3DXAnimationController *iface,
@@ -486,6 +517,7 @@ HRESULT WINAPI D3DXCreateAnimationController(UINT max_outputs, UINT max_sets,
         UINT max_tracks, UINT max_events, ID3DXAnimationController **controller)
 {
     struct d3dx9_animation_controller *object;
+    unsigned int i;
 
     TRACE("max_outputs %u, max_sets %u, max_tracks %u, max_events %u, controller %p.\n",
             max_outputs, max_sets, max_tracks, max_events, controller);
@@ -516,6 +548,8 @@ HRESULT WINAPI D3DXCreateAnimationController(UINT max_outputs, UINT max_sets,
         free(object);
         return E_OUTOFMEMORY;
     }
+    for (i = 0; i < max_tracks; ++i)
+        object->tracks[i].set_idx = -1;
     object->max_tracks  = max_tracks;
     object->max_events  = max_events;
 
-- 
2.50.1


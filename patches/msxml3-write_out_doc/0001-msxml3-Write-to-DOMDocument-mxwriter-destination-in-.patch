From a1d009010d674af140dbcb7d8b4dab4fad7dbc2e Mon Sep 17 00:00:00 2001
From: Jefferson Carpenter <jeffersoncarpenter2@gmail.com>
Date: Thu, 4 Nov 2021 22:30:05 +0000
Subject: [PATCH] msxml3: Write to DOMDocument mxwriter destination in
 endDocument.

---
 dlls/msxml3/mxwriter.c | 41 +++++++++++++++++++++++++++++++++++++++--
 1 file changed, 39 insertions(+), 2 deletions(-)

diff --git a/dlls/msxml3/mxwriter.c b/dlls/msxml3/mxwriter.c
index 29b286356ec..1f4030db7cb 100644
--- a/dlls/msxml3/mxwriter.c
+++ b/dlls/msxml3/mxwriter.c
@@ -168,6 +168,7 @@ typedef struct
     BSTR element;
 
     IStream *dest;
+    IXMLDOMDocument *dest_doc;
 
     output_buffer buffer;
 } mxwriter;
@@ -829,6 +830,7 @@ static ULONG WINAPI mxwriter_Release(IMXWriter *iface)
         free_output_buffer(&This->buffer);
 
         if (This->dest) IStream_Release(This->dest);
+        if (This->dest_doc) IXMLDOMDocument_Release(This->dest_doc);
         SysFreeString(This->version);
         SysFreeString(This->encoding);
 
@@ -893,6 +895,8 @@ static HRESULT WINAPI mxwriter_put_output(IMXWriter *iface, VARIANT dest)
     {
         if (This->dest) IStream_Release(This->dest);
         This->dest = NULL;
+        if (This->dest_doc) IXMLDOMDocument_Release(This->dest_doc);
+        This->dest_doc = NULL;
         close_output_buffer(This);
         break;
     }
@@ -908,12 +912,33 @@ static HRESULT WINAPI mxwriter_put_output(IMXWriter *iface, VARIANT dest)
 
             if (This->dest) IStream_Release(This->dest);
             This->dest = stream;
+            if (This->dest_doc) IXMLDOMDocument_Release(This->dest_doc);
+            This->dest_doc = NULL;
             break;
         }
 
         FIXME("unhandled interface type for VT_UNKNOWN destination\n");
         return E_NOTIMPL;
     }
+    case VT_DISPATCH:
+    {
+        IXMLDOMDocument *doc;
+
+        hr = IDispatch_QueryInterface(V_DISPATCH(&dest), &IID_IXMLDOMDocument, (void**)&doc);
+        if (hr == S_OK)
+        {
+            close_output_buffer(This);
+
+            if (This->dest) IStream_Release(This->dest);
+            This->dest = NULL;
+            if (This->dest_doc) IXMLDOMDocument_Release(This->dest_doc);
+            This->dest_doc = doc;
+            break;
+        }
+
+        FIXME("unhandled interface type for VT_DISPATCH destination\n");
+        return E_NOTIMPL;
+    }
     default:
         FIXME("unhandled destination type %s\n", debugstr_variant(&dest));
         return E_NOTIMPL;
@@ -1180,7 +1205,7 @@ static HRESULT WINAPI SAXContentHandler_putDocumentLocator(
 {
     mxwriter *This = impl_from_ISAXContentHandler( iface );
     FIXME("(%p)->(%p)\n", This, locator);
-    return E_NOTIMPL;
+    return S_OK;
 }
 
 static HRESULT WINAPI SAXContentHandler_startDocument(ISAXContentHandler *iface)
@@ -1218,10 +1243,21 @@ static HRESULT WINAPI SAXContentHandler_startDocument(ISAXContentHandler *iface)
 
 static HRESULT WINAPI SAXContentHandler_endDocument(ISAXContentHandler *iface)
 {
+    HRESULT hr;
+    VARIANT dest;
+    VARIANT_BOOL success;
     mxwriter *This = impl_from_ISAXContentHandler( iface );
     TRACE("(%p)\n", This);
     This->prop_changed = FALSE;
-    return flush_output_buffer(This);
+
+    hr = flush_output_buffer(This);
+    if (FAILED(hr)) return hr;
+
+    if (This->dest_doc) {
+        mxwriter_get_output(&This->IMXWriter_iface, &dest);
+        return IXMLDOMDocument_loadXML(This->dest_doc, V_BSTR(&dest), &success);
+    }
+    return S_OK;
 }
 
 static HRESULT WINAPI SAXContentHandler_startPrefixMapping(
@@ -2608,6 +2644,7 @@ HRESULT MXWriter_create(MSXML_VERSION version, void **ppObj)
     This->newline = FALSE;
 
     This->dest = NULL;
+    This->dest_doc = NULL;
 
     hr = init_output_buffer(This->xml_enc, &This->buffer);
     if (hr != S_OK) {
-- 
2.51.0

